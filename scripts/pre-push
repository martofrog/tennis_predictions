#!/bin/bash
#
# Git pre-push hook for Tennis Predictions
# 
# This hook:
# 1. Runs all tests and ensures they pass
# 2. Scans for leaked secrets (API keys, passwords, tokens)
# 3. Prevents push if tests fail or secrets are found
#
# To bypass (emergency only): git push --no-verify

set -e

echo "üîç Pre-push validation starting..."
echo "================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the root directory of the git repo
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

# ============================================================================
# STEP 1: Run Tests
# ============================================================================
echo ""
echo "üìã Step 1/2: Running tests..."
echo "---------------------------------"

if [ -f "bin/python" ]; then
    PYTHON="bin/python"
elif command -v python3 &> /dev/null; then
    PYTHON="python3"
else
    PYTHON="python"
fi

# Run tests with minimal output
if $PYTHON -m pytest tests/ -q --tb=no --no-cov 2>&1 | grep -E "(passed|failed|error)"; then
    TEST_RESULT=${PIPESTATUS[0]}
    if [ $TEST_RESULT -ne 0 ]; then
        echo ""
        echo -e "${RED}‚ùå TESTS FAILED${NC}"
        echo ""
        echo "Please fix failing tests before pushing."
        echo "Run: bin/python -m pytest tests/ -v"
        echo ""
        echo "To push anyway (not recommended): git push --no-verify"
        exit 1
    else
        echo -e "${GREEN}‚úì All tests passed${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Could not run tests (pytest not found?)${NC}"
    echo "Continuing anyway..."
fi

# ============================================================================
# STEP 2: Check for Secrets
# ============================================================================
echo ""
echo "üîê Step 2/2: Checking for leaked secrets..."
echo "---------------------------------"

# Get list of files being pushed (staged + committed but not pushed)
FILES_TO_CHECK=$(git diff --name-only --cached --diff-filter=ACM)
if [ -z "$FILES_TO_CHECK" ]; then
    FILES_TO_CHECK=$(git diff --name-only HEAD @{u} 2>/dev/null || git diff --name-only HEAD)
fi

# If still no files, check all tracked files
if [ -z "$FILES_TO_CHECK" ]; then
    FILES_TO_CHECK=$(git ls-files)
fi

SECRETS_FOUND=0

# Secret patterns to check for
declare -a SECRET_PATTERNS=(
    # API Keys
    "sk-[a-zA-Z0-9]{32,}"                    # OpenAI-style keys
    "sk_live_[a-zA-Z0-9]{24,}"              # Stripe keys
    "pk_live_[a-zA-Z0-9]{24,}"              # Stripe public keys
    "AIza[0-9A-Za-z\\-_]{35}"               # Google API keys
    "AKIA[0-9A-Z]{16}"                      # AWS Access Key
    "ya29\\.[0-9A-Za-z\\-_]+"               # Google OAuth
    "xox[baprs]-[0-9a-zA-Z]{10,48}"         # Slack tokens
    
    # Generic patterns
    "['\"]api[_-]?key['\"]\\s*[:=]\\s*['\"][^'\"]{20,}['\"]"
    "['\"]secret[_-]?key['\"]\\s*[:=]\\s*['\"][^'\"]{20,}['\"]"
    "['\"]api[_-]?token['\"]\\s*[:=]\\s*['\"][^'\"]{20,}['\"]"
    "['\"]access[_-]?token['\"]\\s*[:=]\\s*['\"][^'\"]{20,}['\"]"
    "['\"]auth[_-]?token['\"]\\s*[:=]\\s*['\"][^'\"]{20,}['\"]"
    "['\"]bearer['\"]\\s*[:=]\\s*['\"][^'\"]{20,}['\"]"
    
    # Passwords (avoid false positives)
    "password\\s*=\\s*['\"][^'\"]{8,}['\"]"
    "passwd\\s*=\\s*['\"][^'\"]{8,}['\"]"
    
    # Private keys
    "-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----"
    
    # Database URLs with credentials
    "(postgres|mysql|mongodb)://[^:]+:[^@]+@"
)

# Files/directories to skip
SKIP_PATTERNS="(\.git/|node_modules/|venv/|\.pyc$|\.jpg$|\.png$|\.svg$|\.ico$|package-lock\.json|\.lock$)"

echo "Scanning files for secrets..."

for file in $FILES_TO_CHECK; do
    # Skip binary files and excluded patterns
    if [[ $file =~ $SKIP_PATTERNS ]] || ! [ -f "$file" ]; then
        continue
    fi
    
    # Check each pattern
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if grep -HnE "$pattern" "$file" 2>/dev/null; then
            echo -e "${RED}‚ö†Ô∏è  Potential secret found in: $file${NC}"
            SECRETS_FOUND=$((SECRETS_FOUND + 1))
        fi
    done
done

# Check for .env files being committed (should never happen)
ENV_FILES=$(echo "$FILES_TO_CHECK" | grep -E "^\.env$|^\.env\.local$|^\.env\.prod$" || true)
if [ ! -z "$ENV_FILES" ]; then
    echo -e "${RED}‚ùå DANGER: .env file being committed!${NC}"
    echo "$ENV_FILES"
    SECRETS_FOUND=$((SECRETS_FOUND + 1))
fi

# Check for hardcoded IPs or URLs with credentials (skip README/markdown files as they contain examples)
FILES_TO_CHECK_CREDENTIALS=$(echo "$FILES_TO_CHECK" | grep -vE "(README|\.md$)" || true)
if [ ! -z "$FILES_TO_CHECK_CREDENTIALS" ]; then
    CREDENTIAL_URL_MATCHES=$(echo "$FILES_TO_CHECK_CREDENTIALS" | xargs grep -HnE "https?://[^:]+:[^@]+@" 2>/dev/null || true)
    if [ ! -z "$CREDENTIAL_URL_MATCHES" ]; then
        echo "$CREDENTIAL_URL_MATCHES"
        echo -e "${YELLOW}‚ö†Ô∏è  URLs with credentials found${NC}"
        SECRETS_FOUND=$((SECRETS_FOUND + 1))
    fi
fi

if [ $SECRETS_FOUND -gt 0 ]; then
    echo ""
    echo -e "${RED}‚ùå SECRETS DETECTED!${NC}"
    echo ""
    echo "Found $SECRETS_FOUND potential secret(s) in your code."
    echo ""
    echo "Please:"
    echo "  1. Remove hardcoded secrets from your code"
    echo "  2. Use environment variables or .env files (which are gitignored)"
    echo "  3. Rotate any exposed secrets immediately"
    echo ""
    echo "If these are false positives, you can:"
    echo "  - Add exceptions to the pre-push hook"
    echo "  - Push anyway with: git push --no-verify (NOT RECOMMENDED)"
    echo ""
    exit 1
else
    echo -e "${GREEN}‚úì No secrets detected${NC}"
fi

# ============================================================================
# Success!
# ============================================================================
echo ""
echo "================================="
echo -e "${GREEN}‚úÖ Pre-push validation passed!${NC}"
echo "================================="
echo ""

exit 0



